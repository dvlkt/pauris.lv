{% extends "base.html" %}

{% block title %}{{ name }}{% endblock %}

{% block content %}

<main class="fill-form">
    <h1>{{ name }}</h1>

    <div id="form"></div>

    <button onclick="submit()">Iesniegt</button>
    <button onclick="loginDialog.showModal()">Rediģēt</button>
</main>

<footer>
    <p>
        Izveidots, izmantojot
        <a href="{{ url_for('home') }}">pauris.lv veidlapu veidotāju</a>.
    </p>
</footer>

<dialog id="login">
    <p>Lai rediģētu veidlapu, ievadi paroli:</p>
    <input type="password" id="password" value="" />
    <button onclick="login()">Rediģēt</button>
</dialog>

<script type="text/javascript">
    let loginDialog = document.querySelector("dialog#login");

    let data = {{ questions|tojson }};
    let form = document.querySelector("#form");
    for (let i = 0; i < data.length; i++) {
        if (data[i].type == "short_text") {
            form.innerHTML += `
                <div class="question" data-type="${data[i].type}">
                    <label for="${data[i].id}">${data[i].text}</label>
                    <input name="${data[i].id}" type="text" />
                </div>
            `;
        }
    }

    const submit = () => {
        let answers = {};
        for (let i = 0; i < data.length; i++) {
            let val = document.querySelector(`[name="${data[i].id}"]`).value;
            answers[data[i].id] = val;
        }
        fetch("/api/fill_form", {
            method: "POST",
            headers: new Headers({ "content-type": "application/json" }),
            body: JSON.stringify({
                id: "{{ id }}",
                answers
            }),
        });
    }

    const login = () => {
        fetch("/api/login", {
            method: "POST",
            headers: new Headers({ "content-type": "application/json" }),
            body: JSON.stringify({
                id: "{{ id }}",
                password: document.querySelector("#password").value
            }),
        }).then(async (res) => {
            response = await res.json();
            if (response.successful) {
                window.location.reload();
            }
        });
    }
</script>

{% endblock %}
