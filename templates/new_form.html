{% extends "base.html" %}

{% block title %}Jauna veidlapa{% endblock %}

{% block content %}

<main class="edit-form">
    <input id="title" placeholder="Veidlapas virsraksts" value="Jauna veidlapa" />

    <div id="questions"></div>

    <button onclick="addQuestion()">+ Pievienot jautājumu</button>

    <button class="centered" onclick="publishDialog.showModal()">Izveidot</button>
</main>

<footer>
    <p>&copy; pauris.lv, 2025.</p>
</footer>

<dialog id="publish-dialog">
    <p>
        Izveidojiet paroli, lai pēc tam varētu piekļūtu veidlapas rezultātiem:
    </p>

    <input type="password" id="password" />

    <div class="btn-wrapper">
        <button onclick="create()">Izveidot</button>
        <button onclick="publishDialog.close()">Izveidot</button>
    </div>
</dialog>

<script type="text/javascript">
    let publishDialog = document.querySelector("dialog#publish-dialog");
    let questionWrapper = document.querySelector("#questions");

    const addQuestion = () => {
        let id = Math.floor(Math.random() * 1000000);

        questionWrapper.insertAdjacentHTML("beforeend", `
            <div class="question" data-id="${id}" data-type="short_text">
                <input type="text" placeholder="Jautājums" value="Jautājums #${questionWrapper.children.length + 1}">

                <select onchange="onQuestionTypeChange(${id})">
                    <option data-type="short_text">Īss teksta lauks</option>
                    <option data-type="long_text">Garš teksta lauks</option>
                    <option data-type="multiple_choice">Izvēles varianti</option>
                    <option data-type="checkbox">Izvēles rūtiņas</option>
                </select>

                <div class="question-options">
                    <div></div>
                    <button onclick="addOption(${id})">+ Jauna izvēle</button>
                </div>
            </div>
        `);

        onQuestionTypeChange(id);
    };

    const onQuestionTypeChange = (id) => {
        let dataType = document.querySelector(`.question[data-id="${id}"] option:nth-child(${document.querySelector(`.question[data-id="${id}"] select`).selectedIndex+1})`).getAttribute("data-type");
        document.querySelector(`.question[data-id="${id}"]`).setAttribute("data-type", dataType);

        if (dataType == "multiple_choice" || dataType == "checkbox") {
            document.querySelector(`.question[data-id="${id}"] .question-options`).style.display = "block";
        } else {
            document.querySelector(`.question[data-id="${id}"] .question-options`).style.display = "none";
        }
    }

    const addOption = (id) => {
        let optionsWrapper = document.querySelector(`.question[data-id="${id}"] .question-options div`);
        optionsWrapper.insertAdjacentHTML("beforeend", `
            <input placeholder="Izvēle" value="Izvēle #${optionsWrapper.children.length + 1}" />
        `);
    }

    const create = () => {
        let data = [];
        for (let element of document.querySelectorAll(".question")) {
            let question = {
                id: element.getAttribute("data-id"),
                type: element.getAttribute("data-type"),
                text: element.querySelector("input").value,
            };
            if (question.type == "multiple_choice" || question.type == "checkbox") {
                let options = [];
                for (let optionElement of element.querySelectorAll(".question-options input")) {
                    options.push(optionElement.value);
                }
                question.options = options;
            }
            data.push(question);
        }
        fetch("/api/create_form", {
            method: "POST",
            headers: new Headers({ "content-type": "application/json" }),
            body: JSON.stringify({
                name: document.querySelector("#title").value,
                password: document.querySelector("#password").value,
                questions: data,
            }),
        }).then(async (res) => {
            let response = await res.json();
            if (response.successful) {
                window.location.href = response.id;
            }
        });
    };
</script>

{% endblock %}
